@startuml State Diagram - Tiết kiệm
!theme plain

title Sơ đồ Trạng thái - Vòng đời Sổ Tiết kiệm (Savings Deposit)

[*] --> ACTIVE : Mở sổ tiết kiệm

state ACTIVE {
  [*] --> Accumulating
  Accumulating : Đang gửi
  Accumulating : Tích lũy lãi\nhàng tháng
  Accumulating --> NearMaturity : Còn 3 ngày\nđến hạn
  NearMaturity : Sắp đáo hạn
  NearMaturity : Gửi SMS\nnhắc nhở
}

ACTIVE --> MATURED : Đến ngày\nđáo hạn

state MATURED {
  [*] --> PendingCustomerChoice
  PendingCustomerChoice : Chờ KH\nchọn hành động
  PendingCustomerChoice : Có 7 ngày\nđể quyết định
}

MATURED --> WITHDRAWN : KH chọn\nRÚT TIỀN

state WITHDRAWN {
  [*] --> WithdrawPrincipalInterest
  WithdrawPrincipalInterest : Rút gốc + lãi\nvào TK thanh toán
}

WITHDRAWN --> CLOSED : Hoàn tất

MATURED --> RENEWED_PRINCIPAL : KH chọn\nTÁI TỤC GỐC

state RENEWED_PRINCIPAL {
  [*] --> CreateNewDeposit
  CreateNewDeposit : Tạo sổ mới\nvới số gốc
  CreateNewDeposit --> TransferInterest
  TransferInterest : Chuyển lãi\nvào TK thanh toán
}

RENEWED_PRINCIPAL --> ACTIVE : Kích hoạt\nsổ mới

MATURED --> RENEWED_FULL : KH chọn\nTÁI TỤC GỐC + LÃI

state RENEWED_FULL {
  [*] --> CreateNewDepositFull
  CreateNewDepositFull : Tạo sổ mới\nvới gốc + lãi
}

RENEWED_FULL --> ACTIVE : Kích hoạt\nsổ mới

MATURED --> AUTO_RENEWED : Sau 7 ngày\nkhông chọn

state AUTO_RENEWED {
  [*] --> DefaultRenewal
  DefaultRenewal : Tự động\ntái tục FULL
}

AUTO_RENEWED --> ACTIVE : Kích hoạt\nsổ mới

ACTIVE --> EARLY_WITHDRAWAL_REQUEST : KH yêu cầu\nRÚT TRƯỚC HẠN

state EARLY_WITHDRAWAL_REQUEST {
  [*] --> CalculatePenalty
  CalculatePenalty : Tính lãi\ntheo 0.5%/năm
  CalculatePenalty --> ConfirmEarlyWithdraw
  ConfirmEarlyWithdraw : Xác nhận\nRút trước hạn
}

EARLY_WITHDRAWAL_REQUEST --> ACTIVE : Hủy\nyêu cầu

EARLY_WITHDRAWAL_REQUEST --> WITHDRAWN_EARLY : Xác nhận\nrút

state WITHDRAWN_EARLY {
  [*] --> ApplyPenaltyRate
  ApplyPenaltyRate : Áp dụng\nlãi suất 0.5%
  ApplyPenaltyRate --> TransferFund
  TransferFund : Chuyển gốc +\nlãi (0.5%) vào TK
}

WITHDRAWN_EARLY --> CLOSED : Hoàn tất

state CLOSED {
  [*] --> DepositClosed
  DepositClosed : Sổ đã đóng
  DepositClosed : Lưu trữ\nlịch sử
}

CLOSED --> [*]

note right of ACTIVE
  **Trạng thái hoạt động**
  - Tính lãi hàng tháng
  - Gửi thông báo trước 3 ngày
  - Không thể nạp thêm
  - Có thể rút trước hạn
end note

note right of MATURED
  **Xử lý đáo hạn:**
  Khách hàng có 3 lựa chọn:
  1. WITHDRAW: Rút gốc + lãi
  2. RENEW_PRINCIPAL: Tái tục gốc
  3. RENEW_FULL: Tái tục gốc + lãi
  
  Nếu không chọn sau 7 ngày:
  → Tự động tái tục FULL
end note

note right of WITHDRAWN_EARLY
  **Rút trước hạn:**
  - Lãi suất phạt: 0.5%/năm
  - Không tính phí rút
  - Yêu cầu OTP xác nhận
  - Không thể hoàn tác
  
  Công thức:
  interest = principal × 0.5% × (days/365)
end note

note right of RENEWED_PRINCIPAL
  **Tái tục gốc:**
  - Tạo sổ mới với số gốc cũ
  - Chuyển lãi vào TK thanh toán
  - Lãi suất = lãi suất hiện hành
  - Kỳ hạn = kỳ hạn cũ
end note

note right of RENEWED_FULL
  **Tái tục gốc + lãi:**
  - Tạo sổ mới với (gốc + lãi)
  - Lãi suất = lãi suất hiện hành
  - Kỳ hạn = kỳ hạn cũ
  - Lãi kép mạnh mẽ
end note

@enduml











