# PHÂN TÍCH THIẾT KẾ KIẾN TRÚC HỆ THỐNG

## TỔNG QUAN

File này phân tích kiến trúc hệ thống quản lý ngân hàng, tập trung vào:
- Công nghệ và công cụ sử dụng
- Kiến trúc database và các cơ chế tự động hóa (triggers, procedures, views)
- Các biện pháp tối ưu và bảo mật

**Lưu ý**: Đây là phân tích kiến trúc tập trung vào **Database Architecture** và **Technology Stack**. Một phân tích kiến trúc đầy đủ thường cần thêm các phần về System Architecture, Component Architecture, Deployment Architecture, và Non-functional Requirements.

---

## 1. CÔNG NGHỆ SỬ DỤNG

### 1.1. Frontend
- **React 18**: Framework JavaScript cho giao diện người dùng
- **Vite 7.1.7**: Build tool và development server
- **React Router DOM 7.9.4**: Quản lý routing và điều hướng
- **Recharts 3.3.0**: Thư viện vẽ biểu đồ
- **Lucide React**: Icon library
- **CSS3**: Styling với CSS Variables

### 1.2. Database
- **MySQL 8.0**: Hệ quản trị cơ sở dữ liệu quan hệ
- **InnoDB Engine**: Storage engine hỗ trợ transactions và foreign keys
- **Character Set**: utf8mb4 (hỗ trợ Unicode đầy đủ)

### 1.3. Backend (Dự kiến)
- **Spring Boot** hoặc **Node.js + Express**: Framework backend
- **JWT Token**: Xác thực và phân quyền
- **RESTful API**: Kiến trúc API

## 2. KIẾN TRÚC HỆ THỐNG

Hệ thống được thiết kế theo mô hình **3-Tier Architecture**:
- **Presentation Layer**: React frontend với 4 dashboard (Customer, Admin, Teller, Loan Officer)
- **Business Logic Layer**: Backend API (dự kiến)
- **Data Layer**: MySQL database với 19 bảng chính

## 3. CÁC TRIGGER CẦN THIẾT

### 3.1. Trigger tính LTV Ratio tự động
**Mục đích**: Tự động tính Loan-to-Value ratio khi tài sản thế chấp được định giá lại hoặc khi khoản vay được tạo/cập nhật.

**Khi nào chạy**: 
- Sau khi INSERT hoặc UPDATE bảng `Collaterals` (khi `appraised_value` thay đổi)
- Sau khi INSERT hoặc UPDATE bảng `Loans` (khi `loan_amount` hoặc `collateral_value` thay đổi)

**Hành động**: Cập nhật `ltv_ratio` trong bảng `Loans` = (loan_amount / appraised_value) * 100

### 3.2. Trigger cập nhật số dư tài khoản
**Mục đích**: Tự động cập nhật số dư tài khoản khi có giao dịch thành công.

**Khi nào chạy**: Sau khi INSERT vào bảng `Transactions` với status = 'SUCCESS'

**Hành động**: 
- Nếu `from_account_id` có giá trị: Trừ tiền từ tài khoản nguồn
- Nếu `to_account_id` có giá trị: Cộng tiền vào tài khoản đích
- Cập nhật `balance_after` trong bảng `Transactions`

### 3.3. Trigger cập nhật outstanding_balance
**Mục đích**: Tự động cập nhật số dư nợ còn lại của khoản vay khi có thanh toán.

**Khi nào chạy**: Sau khi INSERT vào bảng `LoanPayments`

**Hành động**: Cập nhật `outstanding_balance` trong bảng `Loans` = outstanding_balance - principal_paid

### 3.4. Trigger cập nhật điểm tín dụng khi trả nợ
**Mục đích**: Tự động cập nhật điểm tín dụng khi khách hàng trả nợ đúng hạn hoặc quá hạn.

**Khi nào chạy**: Sau khi INSERT vào bảng `LoanPayments` hoặc khi `LoanPaymentSchedule.status` thay đổi thành 'PAID' hoặc 'OVERDUE'

**Hành động**: 
- Nếu trả đúng hạn: Tăng điểm tín dụng (+5 đến +10 điểm)
- Nếu quá hạn: Giảm điểm tín dụng (-10 đến -30 điểm tùy số ngày quá hạn)
- Cập nhật `on_time_payment_rate` và `late_payments` trong bảng `CreditScores`
- Ghi lịch sử vào bảng `CreditScoreHistory`

### 3.5. Trigger cập nhật status khoản vay
**Mục đích**: Tự động cập nhật trạng thái khoản vay dựa trên outstanding_balance và ngày đáo hạn.

**Khi nào chạy**: 
- Sau khi UPDATE `outstanding_balance` trong bảng `Loans`
- Khi kiểm tra ngày đáo hạn (có thể dùng scheduled event)

**Hành động**: 
- Nếu `outstanding_balance` = 0: Cập nhật status = 'PAID_OFF'
- Nếu có kỳ trả nợ quá hạn > 7 ngày: Cập nhật status = 'OVERDUE'
- Nếu đã đến ngày đáo hạn và còn nợ: Cập nhật status = 'OVERDUE'

### 3.6. Trigger tính lãi tiết kiệm tự động
**Mục đích**: Tự động tính và cập nhật lãi tiết kiệm hàng tháng.

**Khi nào chạy**: Chạy định kỳ (scheduled event) vào cuối mỗi tháng

**Hành động**: 
- Tính lãi cho các sổ tiết kiệm có status = 'ACTIVE'
- Cập nhật `total_interest_earned` trong bảng `SavingsDeposits`
- Tạo bản ghi trong bảng `SavingsTransactions` với transaction_type = 'INTEREST_PAYMENT'

### 3.7. Trigger cập nhật status sổ tiết kiệm
**Mục đích**: Tự động cập nhật trạng thái sổ tiết kiệm khi đến ngày đáo hạn.

**Khi nào chạy**: Chạy định kỳ (scheduled event) hàng ngày để kiểm tra ngày đáo hạn

**Hành động**: 
- Nếu `maturity_date` <= ngày hiện tại và status = 'ACTIVE': Cập nhật status = 'MATURED'
- Nếu `auto_renew` = 'YES': Tạo sổ tiết kiệm mới với cùng thông tin

### 3.8. Trigger kiểm tra số dư tối thiểu
**Mục đích**: Đảm bảo số dư tài khoản không thấp hơn số dư tối thiểu quy định.

**Khi nào chạy**: Trước khi UPDATE `balance` trong bảng `Accounts` (BEFORE UPDATE trigger)

**Hành động**: 
- Kiểm tra `balance` >= `min_balance` (từ bảng `AccountTypes`)
- Nếu vi phạm: Ngăn chặn transaction và báo lỗi

### 3.9. Trigger ghi log thay đổi điểm tín dụng
**Mục đích**: Tự động ghi lịch sử mỗi khi điểm tín dụng thay đổi.

**Khi nào chạy**: Sau khi UPDATE bảng `CreditScores`

**Hành động**: Tạo bản ghi mới trong bảng `CreditScoreHistory` với:
- `old_score` và `new_score`
- `score_change` = new_score - old_score
- `old_grade` và `new_grade`
- `reason` và `event_type`

### 3.10. Trigger cập nhật status thẻ khi hết hạn
**Mục đích**: Tự động cập nhật trạng thái thẻ ngân hàng khi đến ngày hết hạn.

**Khi nào chạy**: Chạy định kỳ (scheduled event) hàng ngày

**Hành động**: 
- Nếu `expiry_date` < ngày hiện tại và status = 'ACTIVE': Cập nhật status = 'EXPIRED'

## 4. CÁC STORED PROCEDURES CẦN THIẾT

### 4.1. Procedure tạo khoản vay mới
**Mục đích**: Xử lý logic tạo khoản vay bao gồm kiểm tra điều kiện, tính toán LTV, tạo lịch trả nợ.

**Tham số**: customer_id, loan_type_id, loan_amount, term_months, collateral_id, purpose

**Hành động**: 
- Kiểm tra điểm tín dụng và điều kiện vay
- Tính LTV ratio nếu có tài sản thế chấp
- Tạo bản ghi trong bảng `Loans` với status = 'PENDING'
- Tạo lịch trả nợ trong bảng `LoanPaymentSchedule`

### 4.2. Procedure xử lý thanh toán khoản vay
**Mục đích**: Xử lý thanh toán khoản vay, cập nhật số dư, tính phí quá hạn nếu có.

**Tham số**: loan_id, payment_amount, payment_date, payment_method

**Hành động**: 
- Kiểm tra số tiền thanh toán
- Tính phí quá hạn nếu có
- Cập nhật `outstanding_balance`
- Tạo bản ghi trong `LoanPayments` và `Transactions`
- Cập nhật status trong `LoanPaymentSchedule`

### 4.3. Procedure tính lãi tiết kiệm
**Mục đích**: Tính lãi tiết kiệm cho một sổ tiết kiệm hoặc tất cả sổ tiết kiệm đang hoạt động.

**Tham số**: deposit_id (optional, nếu NULL thì tính cho tất cả)

**Hành động**: 
- Tính lãi theo công thức: principal * interest_rate / 12
- Cập nhật `total_interest_earned`
- Tạo bản ghi trong `SavingsTransactions`

### 4.4. Procedure xử lý đáo hạn tiết kiệm
**Mục đích**: Xử lý đáo hạn sổ tiết kiệm, tính tổng tiền nhận được, xử lý tái tục hoặc rút tiền.

**Tham số**: deposit_id, action ('WITHDRAW', 'RENEW_ALL', 'RENEW_PRINCIPAL')

**Hành động**: 
- Tính tổng tiền (principal + lãi)
- Nếu WITHDRAW: Cộng tiền vào tài khoản, cập nhật status = 'CLOSED'
- Nếu RENEW: Tạo sổ tiết kiệm mới với thông tin tương ứng

### 4.5. Procedure tính toán điểm tín dụng
**Mục đích**: Tính toán lại điểm tín dụng dựa trên các yếu tố: lịch sử thanh toán, tỷ lệ nợ/thu nhập, số tháng sử dụng dịch vụ.

**Tham số**: customer_id

**Hành động**: 
- Thu thập dữ liệu từ các bảng: Loans, LoanPayments, Accounts, Customers
- Tính toán các chỉ số: on_time_payment_rate, debt_to_income_ratio, account_age_months
- Áp dụng công thức tính điểm
- Xác định grade tương ứng
- Cập nhật bảng `CreditScores`
- Ghi lịch sử vào `CreditScoreHistory`

## 5. CÁC VIEWS CẦN THIẾT

### 5.1. View LoanDetails
**Mục đích**: Tổng hợp thông tin chi tiết khoản vay bao gồm thông tin khách hàng, loại vay, tài sản thế chấp.

**Bảng liên quan**: Loans, Customers, LoanTypes, Collaterals, CollateralTypes, Employees

### 5.2. View CustomerSummary
**Mục đích**: Tổng hợp thông tin khách hàng bao gồm số tài khoản, tổng số dư, số khoản vay, tổng dư nợ.

**Bảng liên quan**: Customers, Accounts, Loans, CreditScores

### 5.3. View TransactionDetails
**Mục đích**: Chi tiết giao dịch kèm thông tin tài khoản nguồn, tài khoản đích, loại giao dịch.

**Bảng liên quan**: Transactions, Accounts, TransactionTypes

### 5.4. View SavingsSummary
**Mục đích**: Tổng hợp thông tin sổ tiết kiệm kèm thông tin khách hàng, lãi suất, số ngày còn lại đến đáo hạn.

**Bảng liên quan**: SavingsDeposits, Customers, SavingsInterestRates, Accounts

### 5.5. View OverdueLoans
**Mục đích**: Danh sách các khoản vay quá hạn với thông tin chi tiết về số ngày quá hạn, số tiền quá hạn.

**Bảng liên quan**: Loans, LoanPaymentSchedule, Customers

## 6. INDEXES VÀ TỐI ƯU

### 6.1. Indexes đã tạo
- Primary keys trên tất cả các bảng
- Foreign keys với indexes
- Indexes trên các trường thường xuyên query: customer_id, account_number, loan_number, transaction_date, status

### 6.2. Composite Indexes cần thêm
- `(customer_id, status)` trên bảng Loans
- `(customer_id, transaction_date DESC)` trên bảng Transactions
- `(loan_id, due_date)` trên bảng LoanPaymentSchedule
- `(customer_id, created_at DESC)` trên bảng CreditScoreHistory

## 7. BẢO MẬT VÀ PHÂN QUYỀN

### 7.1. Database Level
- Foreign key constraints đảm bảo referential integrity
- CHECK constraints trên các trường quan trọng (amount > 0, score range)
- UNIQUE constraints trên các trường không được trùng lặp

### 7.2. Application Level
- Role-based access control (4 roles: CUSTOMER, TELLER, LOAN_OFFICER, ADMIN)
- Route protection dựa trên role
- Password hashing (bcrypt trong production)

## 8. CÁC PHẦN CÒN THIẾU TRONG PHÂN TÍCH KIẾN TRÚC ĐẦY ĐỦ

Một phân tích kiến trúc phần mềm đầy đủ thường cần thêm các phần sau:

### 8.1. System Architecture (Kiến trúc hệ thống)
- **Mô hình kiến trúc tổng thể**: 3-tier, MVC, Microservices, etc.
- **Component Architecture**: Các module/component chính và mối quan hệ
- **Layered Architecture**: Phân tầng rõ ràng (Presentation, Business, Data)
- **Communication Patterns**: Cách các component giao tiếp (REST, Message Queue, etc.)

### 8.2. Deployment Architecture (Kiến trúc triển khai)
- **Infrastructure**: Server, database, load balancer
- **Scalability**: Horizontal/vertical scaling strategy
- **High Availability**: Failover, redundancy
- **Network Architecture**: Network topology, security zones

### 8.3. Data Flow Architecture (Kiến trúc luồng dữ liệu)
- **Request Flow**: Luồng xử lý request từ client đến database
- **Data Flow**: Cách dữ liệu di chuyển giữa các layer
- **Event Flow**: Xử lý events, async operations

### 8.4. Integration Architecture (Kiến trúc tích hợp)
- **External Systems**: Tích hợp với hệ thống bên ngoài (Payment Gateway, SMS, Email)
- **API Design**: RESTful API structure, endpoints
- **Data Exchange**: Format dữ liệu trao đổi (JSON, XML)

### 8.5. Security Architecture (Kiến trúc bảo mật)
- **Authentication & Authorization**: Cơ chế xác thực, phân quyền
- **Data Encryption**: Mã hóa dữ liệu nhạy cảm
- **Network Security**: Firewall, VPN, SSL/TLS
- **Audit & Logging**: Ghi log, audit trail

### 8.6. Non-functional Requirements (Yêu cầu phi chức năng)
- **Performance**: Response time, throughput, latency
- **Scalability**: Khả năng mở rộng
- **Reliability**: Uptime, error handling
- **Maintainability**: Code organization, documentation
- **Usability**: User experience

### 8.7. Risk Analysis (Phân tích rủi ro)
- **Technical Risks**: Rủi ro kỹ thuật và giải pháp
- **Business Risks**: Rủi ro nghiệp vụ
- **Mitigation Strategies**: Chiến lược giảm thiểu rủi ro

### 8.8. Design Patterns (Mẫu thiết kế)
- **Creational Patterns**: Factory, Singleton
- **Structural Patterns**: Adapter, Facade
- **Behavioral Patterns**: Observer, Strategy

## 9. KẾT LUẬN

File này tập trung vào **Database Architecture** và **Technology Stack** - hai phần quan trọng của kiến trúc hệ thống. Hệ thống được thiết kế với kiến trúc 3 tầng rõ ràng, database được normalize tốt với 19 bảng chính. Các trigger, stored procedures và views được đề xuất nhằm tự động hóa các nghiệp vụ quan trọng, đảm bảo tính nhất quán dữ liệu và giảm thiểu lỗi do xử lý thủ công.

Để có phân tích kiến trúc đầy đủ, cần bổ sung thêm các phần về System Architecture, Deployment Architecture, và Non-functional Requirements như đã nêu ở mục 8.

