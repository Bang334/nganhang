@startuml Chuyển Khoản
autonumber
title Luồng Chuyển Khoản

actor "Khách hàng" as Customer
participant "Web/App" as App
participant "System" as System
database "Database" as DB

Customer -> App: Đăng nhập
App -> System: Authenticate
System --> App: Token

Customer -> App: Nhập thông tin chuyển khoản\n(STK người nhận, số tiền, nội dung)
App -> System: Validate STK người nhận

System -> DB: Tìm Account (người nhận)
DB --> System: Account info

alt Account người nhận tồn tại
    System --> App: Hiển thị tên người nhận
    
    Customer -> App: Xác nhận chuyển khoản
    App -> System: Execute Transfer
    
    System -> DB: BEGIN TRANSACTION
    
    System -> DB: SELECT balance FROM Accounts\nWHERE account_id = from_account\nFOR UPDATE
    DB --> System: Current balance
    
    alt Số dư đủ
        System -> DB: UPDATE Accounts\nSET balance = balance - amount\nWHERE account_id = from_account
        DB --> System: OK
        
        System -> DB: UPDATE Accounts\nSET balance = balance + amount\nWHERE account_id = to_account
        DB --> System: OK
        
        System -> DB: INSERT Transaction\n(type = TRANSFER)
        DB --> System: transaction_id
        
        System -> DB: COMMIT
        
        System --> App: Chuyển khoản thành công
        App --> Customer: Hiển thị biên lai
    else Số dư không đủ
        System -> DB: ROLLBACK
        System --> App: Lỗi: Số dư không đủ
        App --> Customer: Thông báo lỗi
    end
    
else Account người nhận không tồn tại
    System --> App: Lỗi: STK không tồn tại
    App --> Customer: Thông báo lỗi
end

@enduml

