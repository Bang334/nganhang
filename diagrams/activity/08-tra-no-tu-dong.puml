@startuml Activity - Trả nợ tự động

title Trả nợ - Auto Debit

|Hệ thống|
start
:Chạy job hàng ngày\n00:30 AM;

:SELECT repayments\nWHERE due_date = TODAY\nAND status = PENDING;

if (Có kỳ đến hạn?) then (no)
  stop
endif

|Hệ thống|
fork
  :Kỳ 1;
  :Check balance TK;
  if (Balance >= Amount?) then (yes)
    :Trừ tiền;
    :Cập nhật dư nợ;
    :Status = PAID;
    :SMS success;
  else (no)
    :Status = OVERDUE;
    :SMS warning;
  endif
fork again
  :Kỳ 2;
  :Check balance;
  if (OK?) then (yes)
    :Process payment;
  else (no)
    :Mark OVERDUE;
  endif
fork again
  :Kỳ 3...;
end fork

stop

@enduml

