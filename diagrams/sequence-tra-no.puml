@startuml Trả nợ

title Nghiệp vụ: Trả nợ hàng tháng

participant System
participant DB

== Trả nợ tự động ==
System -> DB: SELECT loans\nWHERE repayment_due = TODAY

loop Each loan
  System -> DB: CHECK account balance
  alt Balance >= payment_amount
    System -> DB: START TRANSACTION
    System -> DB: UPDATE account\nbalance -= payment
    System -> DB: UPDATE loan\noutstanding -= principal
    System -> DB: INSERT repayment (PAID)
    System -> DB: COMMIT
    System -> System: Send SMS success
  else Balance < payment_amount
    System -> DB: UPDATE repayment\nstatus = OVERDUE
    System -> System: Send SMS warning
  end
end

@enduml

