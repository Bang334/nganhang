@startuml Thẩm định và Phê duyệt Vay
autonumber
title Luồng Thẩm định và Phê duyệt Khoản Vay

actor "Nhân viên Tín dụng" as LoanOfficer
participant "System" as System
database "Database" as DB

LoanOfficer -> System: Login và xem hồ sơ chờ duyệt
System -> DB: Lấy danh sách hồ sơ vay đang chờ duyệt
DB --> System: Trả về danh sách hồ sơ

LoanOfficer -> System: Chọn hồ sơ để thẩm định
System -> DB: Load thông tin chi tiết (Khách hàng, Khoản vay, Tài sản)
DB --> System: Trả về đầy đủ thông tin hồ sơ
System --> LoanOfficer: Hiển thị thông tin hồ sơ

== Bước 1: Đánh giá Tín dụng ==
LoanOfficer -> System: Nhập thu nhập, tỷ lệ nợ/thu nhập
System -> System: Tính điểm tín dụng (300-850)\nScore = f(payment_history 35%, debt_ratio 30%, account_age 15%, debt_balance 10%, late_payments 10%)
System -> DB: Cập nhật hồ sơ điểm tín dụng của khách
DB --> System: Ghi nhận mã điểm tín dụng
System --> LoanOfficer: Hiển thị điểm và xếp hạng\n(11 cấp: AAA 800-850 → C 300-349)\nLãi suất: 8.5% - 16%/năm

== Bước 2: Thẩm định Tài sản (nếu có) ==
alt Có tài sản thế chấp
    LoanOfficer -> System: Nhập giá trị thẩm định thực tế
    System -> System: Tính LTV ratio\nLTV = (Loan / Collateral) * 100%
    
    alt LTV hợp lệ (≤ Max LTV)
        System -> DB: Cập nhật giá trị thẩm định và trạng thái tài sản
        DB --> System: Xác nhận cập nhật
        System --> LoanOfficer: Tài sản hợp lệ
    else LTV vượt mức
        System --> LoanOfficer: Cảnh báo: LTV vượt mức cho phép
    end
end

== Bước 3: Quyết định Phê duyệt ==
alt Phê duyệt
    LoanOfficer -> System: Nhập số tiền duyệt,\nlãi suất, thời hạn
    System -> System: Tính khoản trả hàng tháng
    
    LoanOfficer -> System: Xác nhận phê duyệt
    System -> DB: Cập nhật hồ sơ vay sang trạng thái ĐÃ DUYỆT
    DB --> System: Xác nhận cập nhật
    
    System -> DB: Tạo lịch trả nợ cho khoản vay
    DB --> System: Xác nhận đã tạo lịch
    
    System --> LoanOfficer: Phê duyệt thành công
    System -> System: Gửi thông báo cho khách hàng
    
else Từ chối
    LoanOfficer -> System: Nhập lý do từ chối
    System -> DB: Cập nhật hồ sơ vay sang trạng thái TỪ CHỐI
    DB --> System: Xác nhận cập nhật
    
    alt Có tài sản thế chấp
        System -> DB: Giải phóng trạng thái tài sản thế chấp
        DB --> System: Xác nhận cập nhật
    end
    
    System --> LoanOfficer: Từ chối thành công
    System -> System: Gửi thông báo cho khách hàng
end

@enduml

