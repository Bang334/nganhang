@startuml Chuyển Khoản
autonumber
title Luồng Chuyển Khoản

actor "Khách hàng" as Customer
participant "Web/App" as App
participant "System" as System
database "Database" as DB

Customer -> App: Đăng nhập
App -> System: Authenticate
System --> App: Token

Customer -> App: Nhập thông tin chuyển khoản\n(STK người nhận, số tiền, nội dung)
App -> System: Validate STK người nhận

System -> DB: Tìm Account (người nhận)
DB --> System: Account info

alt Account người nhận tồn tại
    System --> App: Hiển thị tên người nhận
    
    Customer -> App: Xác nhận chuyển khoản
    App -> System: Execute Transfer
    
    System -> DB: Bắt đầu ghi nhận giao dịch chuyển khoản
    
    System -> DB: Khóa và kiểm tra số dư tài khoản nguồn
    DB --> System: Số dư hiện tại
    
    alt Số dư đủ
        System -> DB: Trừ số tiền khỏi tài khoản nguồn
        DB --> System: Xác nhận cập nhật
        
        System -> DB: Cộng tiền vào tài khoản nhận
        DB --> System: Xác nhận cập nhật
        
        System -> DB: Ghi nhận giao dịch chuyển khoản
        DB --> System: Trả về mã giao dịch
        
        System -> DB: Hoàn tất ghi nhận giao dịch
        
        System --> App: Chuyển khoản thành công
        App --> Customer: Hiển thị biên lai
    else Số dư không đủ
        System -> DB: Hủy ghi nhận giao dịch
        System --> App: Lỗi: Số dư không đủ
        App --> Customer: Thông báo lỗi
    end
    
else Account người nhận không tồn tại
    System --> App: Lỗi: STK không tồn tại
    App --> Customer: Thông báo lỗi
end

@enduml

